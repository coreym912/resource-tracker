<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Resource Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAw4pZk2up_7IG4e9ZfJJC_gMG4YGfEDQc",
			authDomain: "resource-tracking-test-app.firebaseapp.com",
			projectId: "resource-tracking-test-app",
			storageBucket: "resource-tracking-test-app.firebasestorage.app",
			messagingSenderId: "906802546479",
			appId: "1:906802546479:web:f52c69e60e515ffe5803da"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseStorageRef = ref;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
</head>
<body>
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Lucide icons as inline SVGs
        const CameraIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        );

        const MapPinIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const UploadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );

        const LoaderIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
                <line x1="12" y1="2" x2="12" y2="6"/>
                <line x1="12" y1="18" x2="12" y2="22"/>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
                <line x1="2" y1="12" x2="6" y2="12"/>
                <line x1="18" y1="12" x2="22" y2="12"/>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
            </svg>
        );

        const CheckIcon = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-green-500">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const AlertIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        function ResourceTracker() {
            const [image, setImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [location, setLocation] = useState(null);
            const [locationError, setLocationError] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [saving, setSaving] = useState(false);
            const [formData, setFormData] = useState({
                resourceType: '',
                description: '',
                condition: '',
                quantity: '',
                serialNumber: '',
                notes: ''
            });
            const [submitted, setSubmitted] = useState(false);
            
            const fileInputRef = useRef(null);
            const videoRef = useRef(null);
            const [stream, setStream] = useState(null);
            const [cameraActive, setCameraActive] = useState(false);

            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setLocation({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: new Date(position.timestamp).toLocaleString()
                            });
                        },
                        (error) => {
                            setLocationError(error.message);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                }

                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, [stream]);

            const startCamera = async () => {
                try {
                    // Stop any existing stream first
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }

                    console.log('Requesting camera access...');
                    
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };

                    const mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    console.log('Camera access granted');
                    setStream(mediaStream);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = mediaStream;
                        
                        videoRef.current.onloadedmetadata = () => {
                            console.log('Video metadata loaded');
                            console.log('Video dimensions:', videoRef.current.videoWidth, 'x', videoRef.current.videoHeight);
                            
                            videoRef.current.play()
                                .then(() => {
                                    console.log('Video playing');
                                    setCameraActive(true);
                                })
                                .catch(err => {
                                    console.error('Play error:', err);
                                    // Retry after a short delay
                                    setTimeout(() => {
                                        videoRef.current.play()
                                            .then(() => {
                                                console.log('Video playing on retry');
                                                setCameraActive(true);
                                            })
                                            .catch(e => {
                                                alert('Failed to start video: ' + e.message);
                                            });
                                    }, 500);
                                });
                        };
                        
                        videoRef.current.onerror = (e) => {
                            console.error('Video error:', e);
                            alert('Video element error');
                        };
                    }
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    alert('Unable to access camera: ' + error.message);
                }
            };

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    if (videoRef.current) {
                        videoRef.current.srcObject = null;
                    }
                    setStream(null);
                }
                setCameraActive(false);
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                
                if (!video || !stream) {
                    alert('Camera not available');
                    return;
                }

                console.log('Attempting capture...');
                console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                
                if (!video.videoWidth || !video.videoHeight) {
                    console.log('Video dimensions not ready, waiting...');
                    setTimeout(() => {
                        capturePhoto();
                    }, 500);
                    return;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                console.log('Canvas size:', canvas.width, 'x', canvas.height);
                
                const ctx = canvas.getContext('2d');
                
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
                    console.log('DataURL created, length:', dataUrl.length);
                    
                    if (dataUrl && dataUrl.length > 1000) {
                        // Convert dataURL to blob
                        fetch(dataUrl)
                            .then(res => res.blob())
                            .then(blob => {
                                console.log('Blob created, size:', blob.size);
                                setImage(blob);
                                setImagePreview(dataUrl);
                                stopCamera();
                                analyzeImage(blob);
                            })
                            .catch(err => {
                                console.error('Blob conversion error:', err);
                                setImagePreview(dataUrl);
                                stopCamera();
                                alert('Photo captured but may have issues saving. You can still fill out the form.');
                            });
                    } else {
                        console.error('DataURL creation failed');
                        alert('Failed to capture photo. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Capture error:', error);
                    alert('Error capturing photo: ' + error.message);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImagePreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                    analyzeImage(file);
                }
            };

            const analyzeImage = async (imageFile) => {
                setAnalyzing(true);
                
                // OPTION 1: Call Netlify Function (recommended - secure)
                /*
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(imageFile);
                    reader.onloadend = async () => {
                        const base64Image = reader.result;
                        
                        const response = await fetch('/.netlify/functions/analyze-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: base64Image })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'AI analysis failed');
                        }
                        
                        const content = data.choices[0].message.content;
                        const jsonStr = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        const analysis = JSON.parse(jsonStr);
                        
                        setFormData(analysis);
                        setAnalyzing(false);
                    };
                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    alert('AI analysis failed. Please fill in the form manually. Error: ' + error.message);
                    setAnalyzing(false);
                }
                */

                // OPTION 2: Simulated analysis (currently active)
                await new Promise(resolve => setTimeout(resolve, 2000));
                const simulatedAnalysis = {
                    resourceType: 'Equipment',
                    description: 'Resource captured - please review and edit details',
                    condition: 'Good',
                    quantity: '1',
                    serialNumber: '',
                    notes: 'Photo uploaded successfully. Please verify and update the information above.'
                };
                setFormData(simulatedAnalysis);
                setAnalyzing(false);
            };

            const handleSubmit = async () => {
                if (!formData.resourceType || !formData.description) {
                    alert('Please fill in required fields: Resource Type and Description');
                    return;
                }

                setSaving(true);

                try {
                    const timestamp = Date.now();
                    const imageRef = window.firebaseStorageRef(window.firebaseStorage, `resources/${timestamp}.jpg`);
                    await window.firebaseUploadBytes(imageRef, image);
                    const imageUrl = await window.firebaseGetDownloadURL(imageRef);

                    const docRef = await window.firebaseAddDoc(
                        window.firebaseCollection(window.firebaseDb, 'resources'),
                        {
                            ...formData,
                            imageUrl: imageUrl,
                            location: location || null,
                            createdAt: window.firebaseServerTimestamp(),
                            submittedAt: new Date().toISOString()
                        }
                    );

                    console.log('Document saved with ID:', docRef.id);
                    setSaving(false);
                    setSubmitted(true);
                    
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    alert('Error saving data: ' + error.message);
                    setSaving(false);
                }
            };

            const resetForm = () => {
                setImage(null);
                setImagePreview(null);
                setFormData({
                    resourceType: '',
                    description: '',
                    condition: '',
                    quantity: '',
                    serialNumber: '',
                    notes: ''
                });
                setSubmitted(false);
                setAnalyzing(false);
                setSaving(false);
            };

            if (submitted) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                            <div className="flex justify-center mb-4">
                                <CheckIcon />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Resource Tracked!</h2>
                            <p className="text-gray-600">Your resource has been successfully saved to Firebase with location data.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white rounded-lg shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                                <h1 className="text-3xl font-bold mb-2">Resource Tracker</h1>
                                <p className="text-blue-100">AI-powered resource tracking with GPS location</p>
                            </div>

                            <div className="p-6 bg-gray-50 border-b">
                                <div className="flex items-start gap-3">
                                    <div className="mt-1">
                                        <MapPinIcon />
                                    </div>
                                    <div className="flex-1">
                                        {location ? (
                                            <div>
                                                <p className="font-semibold text-gray-800">Location Acquired</p>
                                                <p className="text-sm text-gray-600">
                                                    Lat: {location.latitude.toFixed(6)}, Lng: {location.longitude.toFixed(6)}
                                                </p>
                                                <p className="text-xs text-gray-500">Accuracy: ¬±{location.accuracy.toFixed(0)}m</p>
                                            </div>
                                        ) : locationError ? (
                                            <div className="flex items-start gap-2">
                                                <AlertIcon />
                                                <div>
                                                    <p className="font-semibold text-gray-800">Location Unavailable</p>
                                                    <p className="text-sm text-gray-600">{locationError}</p>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-2">
                                                <LoaderIcon />
                                                <p className="text-gray-600">Getting your location...</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="p-6">
                                {!imagePreview && !cameraActive && (
                                    <div className="space-y-4">
                                        <button
                                            onClick={startCamera}
                                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                                        >
                                            <CameraIcon />
                                            Open Camera
                                        </button>
                                        
                                        <div className="relative">
                                            <div className="absolute inset-0 flex items-center">
                                                <div className="w-full border-t border-gray-300"></div>
                                            </div>
                                            <div className="relative flex justify-center text-sm">
                                                <span className="px-2 bg-white text-gray-500">or</span>
                                            </div>
                                        </div>

                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-4 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                                        >
                                            <UploadIcon />
                                            Upload Photo
                                        </button>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept="image/*"
                                            onChange={handleFileUpload}
                                            style={{ display: 'none' }}
                                        />
                                    </div>
                                )}

                                {cameraActive && (
                                    <div className="space-y-4">
                                        <video
                                            ref={videoRef}
                                            autoPlay
                                            playsInline
                                            muted
                                            className="w-full rounded-lg bg-black"
                                            style={{ minHeight: '300px' }}
                                        />
                                        <div className="flex gap-3">
                                            <button
                                                onClick={capturePhoto}
                                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                            >
                                                Capture Photo
                                            </button>
                                            <button
                                                onClick={stopCamera}
                                                className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {imagePreview && (
                                    <div className="space-y-4">
                                        <img src={imagePreview} alt="Captured resource" className="w-full rounded-lg shadow-md" />
                                        
                                        {analyzing && (
                                            <div className="flex items-center justify-center gap-3 py-4">
                                                <LoaderIcon />
                                                <span className="text-gray-600">Analyzing image with AI...</span>
                                            </div>
                                        )}

                                        {!analyzing && (
                                            <button
                                                onClick={resetForm}
                                                className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors"
                                            >
                                                Take Another Photo
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>

                            {imagePreview && !analyzing && (
                                <div className="p-6 pt-0 space-y-4">
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-blue-800 font-semibold mb-1">Image Captured</p>
                                        <p className="text-xs text-blue-600">Review and edit the information below before submitting.</p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Resource Type *
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.resourceType}
                                            onChange={(e) => setFormData({...formData, resourceType: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., Equipment, Tool, Vehicle"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Description *
                                        </label>
                                        <textarea
                                            required
                                            value={formData.description}
                                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            rows="3"
                                            placeholder="Describe the resource"
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Condition
                                            </label>
                                            <select
                                                value={formData.condition}
                                                onChange={(e) => setFormData({...formData, condition: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                                <option value="">Select</option>
                                                <option value="Excellent">Excellent</option>
                                                <option value="Good">Good</option>
                                                <option value="Fair">Fair</option>
                                                <option value="Poor">Poor</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Quantity
                                            </label>
                                            <input
                                                type="number"
                                                value={formData.quantity}
                                                onChange={(e) => setFormData({...formData, quantity: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="1"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Serial Number / ID
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.serialNumber}
                                            onChange={(e) => setFormData({...formData, serialNumber: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="SN-123456"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Additional Notes
                                        </label>
                                        <textarea
                                            value={formData.notes}
                                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            rows="3"
                                            placeholder="Any additional information..."
                                        />
                                    </div>

                                    <button
                                        onClick={handleSubmit}
                                        disabled={saving}
                                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {saving ? (
                                            <span className="flex items-center justify-center gap-2">
                                                <LoaderIcon />
                                                Saving to Firebase...
                                            </span>
                                        ) : (
                                            'Submit Resource'
                                        )}
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="mt-6 text-center text-sm text-gray-600">
                            <p>üìç Location captured automatically ‚Ä¢ üì± Mobile optimized ‚Ä¢ ‚òÅÔ∏è Firebase backend</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ResourceTracker />, document.getElementById('app'));
    </script>
</body>
</html>

